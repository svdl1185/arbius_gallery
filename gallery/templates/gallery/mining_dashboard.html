{% extends 'gallery/base.html' %}

{% block content %}
<div class="container">
    <!-- Hero Section -->
    <div class="hero-section text-center">
        <h1 class="hero-title">
            <i class="bi bi-cpu"></i> Mining Analytics Dashboard
        </h1>
        <p class="hero-subtitle">
            Comprehensive analytics for Arbius (AIUS) mining operations and network statistics
        </p>
        <div class="mt-3">
            <span class="badge bg-warning text-dark">
                <i class="bi bi-eye-slash"></i> Hidden Dashboard
            </span>
        </div>
    </div>

    <!-- Network Overview -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="info-card">
                <h2 class="section-title">
                    <i class="bi bi-graph-up"></i> Network Overview
                </h2>
                <div class="stats-grid-compact">
                    <div class="stat-item">
                        <div class="stat-number text-primary">{{ total_tasks|floatformat:0 }}</div>
                        <div class="stat-label">Total Tasks Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-success">{{ total_unique_miners }}</div>
                        <div class="stat-label">Active Miners</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-warning">{{ total_estimated_rewards|floatformat:1 }}</div>
                        <div class="stat-label">AIUS Distributed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-info">{{ avg_tasks_per_miner|floatformat:1 }}</div>
                        <div class="stat-label">Avg Tasks/Miner</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-secondary">{{ weekly_stats.tasks_this_week }}</div>
                        <div class="stat-label">Tasks (7 Days)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-secondary">{{ monthly_stats.tasks_this_month }}</div>
                        <div class="stat-label">Tasks (30 Days)</div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="chart-title">Daily Mining Activity</h5>
                            <div class="chart-wrapper">
                                <canvas id="dailyMiningChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5 class="chart-title">Hourly Activity (48H)</h5>
                            <div class="chart-wrapper">
                                <canvas id="hourlyMiningChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Miners Section -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="info-card">
                <h3 class="mb-3">
                    <i class="bi bi-trophy"></i> Top Miners by Volume
                </h3>
                <div class="miner-leaderboard">
                    {% for miner in top_miners_by_volume %}
                    <div class="miner-entry">
                        <div class="miner-rank">{{ forloop.counter }}</div>
                        <div class="miner-info">
                            <div class="miner-name">{{ miner.display_name }}</div>
                            <div class="miner-address">{{ miner.short_address }}</div>
                        </div>
                        <div class="miner-stats">
                            <div class="miner-stat-primary">{{ miner.total_tasks_completed }} tasks</div>
                            <div class="miner-stat-secondary">~{{ miner.estimated_rewards|floatformat:1 }} AIUS</div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No mining data available yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="info-card">
                <h3 class="mb-3">
                    <i class="bi bi-lightning"></i> Top Miners by Consistency
                </h3>
                <div class="miner-leaderboard">
                    {% for miner in top_miners_by_consistency %}
                    <div class="miner-entry">
                        <div class="miner-rank">{{ forloop.counter }}</div>
                        <div class="miner-info">
                            <div class="miner-name">{{ miner.display_name }}</div>
                            <div class="miner-address">{{ miner.short_address }}</div>
                        </div>
                        <div class="miner-stats">
                            <div class="miner-stat-primary">{{ miner.avg_tasks_per_day|floatformat:1 }}/day</div>
                            <div class="miner-stat-secondary">{{ miner.active_days }} active days</div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No consistency data available yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- All Miners Table -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="info-card">
                <h3 class="mb-3">
                    <i class="bi bi-table"></i> All Miners Statistics
                </h3>
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Miner</th>
                                <th>Tasks Completed</th>
                                <th>Est. Rewards (AIUS)</th>
                                <th>Active Days</th>
                                <th>Avg Tasks/Day</th>
                                <th>Users Served</th>
                                <th>First Task</th>
                                <th>Last Task</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for miner in miners_stats %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <div class="miner-cell">
                                        <div class="miner-name">{{ miner.display_name }}</div>
                                        <div class="text-muted small">{{ miner.short_address }}</div>
                                    </div>
                                </td>
                                <td><span class="badge bg-primary">{{ miner.total_tasks_completed }}</span></td>
                                <td><span class="badge bg-success">{{ miner.estimated_rewards|floatformat:1 }}</span></td>
                                <td>{{ miner.active_days }}</td>
                                <td>{{ miner.avg_tasks_per_day|floatformat:2 }}</td>
                                <td>{{ miner.unique_submitters_served }}</td>
                                <td>
                                    {% if miner.first_task %}
                                        {{ miner.first_task|date:"M d, Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if miner.last_task %}
                                        {{ miner.last_task|date:"M d, Y" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center text-muted">No mining data available yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Mining Activity -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="info-card">
                <h3 class="mb-3">
                    <i class="bi bi-activity"></i> Recent Mining Activity
                </h3>
                <div class="recent-activity">
                    {% for activity in recent_mining_activity %}
                    <div class="activity-item">
                        <div class="activity-time">
                            {{ activity.timestamp|date:"M d, H:i" }}
                        </div>
                        <div class="activity-content">
                            <div class="activity-main">
                                <strong>{{ activity.miner_display_name }}</strong> completed task 
                                <code>{{ activity.task_id|truncatechars:12 }}</code>
                            </div>
                            <div class="activity-details text-muted">
                                Submitted by {{ activity.submitter_display_name }} • 
                                Model: {{ activity.model_id|truncatechars:12 }}
                                {% if activity.prompt %}
                                    • "{{ activity.clean_prompt|truncatechars:50 }}"
                                {% endif %}
                            </div>
                        </div>
                        <div class="activity-reward">
                            <span class="badge bg-success">+1.0 AIUS</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No recent mining activity found.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Mining by Model -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="info-card">
                <h3 class="mb-3">
                    <i class="bi bi-diagram-3"></i> Mining Distribution by Model
                </h3>
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Model ID</th>
                                <th>Total Tasks</th>
                                <th>Unique Miners</th>
                                <th>Avg Tasks/Miner</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in mining_by_model %}
                            <tr>
                                <td>
                                    <code>{{ model.model_id|truncatechars:20 }}</code>
                                </td>
                                <td><span class="badge bg-primary">{{ model.total_tasks }}</span></td>
                                <td><span class="badge bg-info">{{ model.unique_miners }}</span></td>
                                <td>{{ model.total_tasks|div:model.unique_miners|floatformat:1 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No model data available yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly/Monthly Comparison -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="info-card">
                <h3 class="mb-3">
                    <i class="bi bi-calendar-week"></i> Weekly Mining Stats
                </h3>
                <div class="stats-grid-compact">
                    <div class="stat-item">
                        <div class="stat-number text-primary">{{ weekly_stats.tasks_this_week }}</div>
                        <div class="stat-label">Tasks Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-success">{{ weekly_stats.unique_miners_this_week }}</div>
                        <div class="stat-label">Active Miners</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-info">{{ weekly_stats.unique_submitters_this_week }}</div>
                        <div class="stat-label">Task Submitters</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="info-card">
                <h3 class="mb-3">
                    <i class="bi bi-calendar-month"></i> Monthly Mining Stats
                </h3>
                <div class="stats-grid-compact">
                    <div class="stat-item">
                        <div class="stat-number text-primary">{{ monthly_stats.tasks_this_month }}</div>
                        <div class="stat-label">Tasks Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-success">{{ monthly_stats.unique_miners_this_month }}</div>
                        <div class="stat-label">Active Miners</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-info">{{ monthly_stats.unique_submitters_this_month }}</div>
                        <div class="stat-label">Task Submitters</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.miner-leaderboard {
    max-height: 400px;
    overflow-y: auto;
}

.miner-entry {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.miner-rank {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 12px;
    font-size: 14px;
}

.miner-info {
    flex: 1;
    min-width: 0;
}

.miner-name {
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 2px;
}

.miner-address {
    font-size: 12px;
    color: #888;
    font-family: 'Courier New', monospace;
}

.miner-stats {
    text-align: right;
}

.miner-stat-primary {
    font-weight: 600;
    color: #4ade80;
    margin-bottom: 2px;
}

.miner-stat-secondary {
    font-size: 12px;
    color: #888;
}

.miner-cell .miner-name {
    font-weight: 600;
    color: #ffffff;
}

.recent-activity {
    max-height: 500px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    border-left: 3px solid #4ade80;
}

.activity-time {
    width: 80px;
    font-size: 11px;
    color: #888;
    text-align: center;
    margin-right: 12px;
}

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-main {
    margin-bottom: 4px;
}

.activity-details {
    font-size: 12px;
}

.activity-reward {
    margin-left: 12px;
}
</style>

<!-- Charts JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Daily Mining Chart
const dailyCtx = document.getElementById('dailyMiningChart').getContext('2d');
new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: {{ daily_chart_data.labels|safe }},
        datasets: [{
            label: 'Tasks Completed',
            data: {{ daily_chart_data.tasks|safe }},
            borderColor: '#4ade80',
            backgroundColor: 'rgba(74, 222, 128, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Active Miners',
            data: {{ daily_chart_data.miners|safe }},
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#ffffff' }
            }
        },
        scales: {
            x: {
                ticks: { color: '#888' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
                ticks: { color: '#888' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
        }
    }
});

// Hourly Mining Chart
const hourlyCtx = document.getElementById('hourlyMiningChart').getContext('2d');
new Chart(hourlyCtx, {
    type: 'bar',
    data: {
        labels: {{ hourly_chart_data.labels|safe }},
        datasets: [{
            label: 'Tasks/Hour',
            data: {{ hourly_chart_data.tasks|safe }},
            backgroundColor: 'rgba(74, 222, 128, 0.6)',
            borderColor: '#4ade80',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#ffffff' }
            }
        },
        scales: {
            x: {
                ticks: { 
                    color: '#888',
                    maxRotation: 45
                },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
                ticks: { color: '#888' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
        }
    }
});
</script>
{% endblock %} 